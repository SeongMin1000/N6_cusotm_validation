 
# Makefile to generate NPU/ATONN relocatable binary files
#
# CLANG version
#
# v1.0 - Initial version
# v1.1 - Additional versions for yet another version of clang
# 
LLVM_COMPILER_PATH?=/Users/LLVM_tests/tools/dist_clang
TARGET_TRIPLET?=thumbv8m.main-unknown-none-eabihf
LLVM_SYSROOT?=${LLVM_COMPILER_PATH}/lib/clang-runtimes/newlib/arm-none-eabi/armv8m.main_hard_fp

THIS_MAKEFILE := $(lastword $(MAKEFILE_LIST))
TOP := $(patsubst %/$(THIS_MAKEFILE),%,$(abspath $(THIS_MAKEFILE)))

CC = ${LLVM_COMPILER_PATH}/bin/clang
OBJDUMP = ${LLVM_COMPILER_PATH}/bin/llvm-objdump
OBJCOPY = ${LLVM_COMPILER_PATH}/bin/llvm-objcopy
SIZE = ${LLVM_COMPILER_PATH}/bin/llvm-size

BUILD_DIR ?= ${TOP}/build_clang
RESOURCES_DIR ?= $(abspath ${THIS_MAKEFILE}/..)

RT_ATON_DIR ?= ${RESOURCES_DIR}/dev/rt_atonn
SW_LIB_DIR ?= ${RESOURCES_DIR}/dev/embednets

SW_LIB_INC_DIR ?= ${SW_LIB_DIR}/inc
SW_LIB_LIB_DIR ?= ${SW_LIB_DIR}/lib
SW_LIB_NAME ?= :network_runtime_clang_pic.a
SW_LIB_PATH ?= -L ${SW_LIB_LIB_DIR} -l${SW_LIB_NAME}

PLT_DIR ?= ${RESOURCES_DIR}/platform/stm32n6

LKR_FILE ?= ${RESOURCES_DIR}/reloc_network_llvm.lkr

TARGET ?= network

$(info ----------------------------)
$(info THIS_MAKEFILE = $(abspath ${THIS_MAKEFILE}))
$(info BUILD_DIR = ${BUILD_DIR})
$(info TARGET = ${TARGET})
$(info RESOURCES_DIR = ${RESOURCES_DIR})
$(info RT_ATON_DIR = ${RT_ATON_DIR})
$(info SW_LIB_INC_DIR = ${SW_LIB_INC_DIR})
$(info SW_LIB_PATH = ${SW_LIB_PATH})
$(info PLT_DIR = ${PLT_DIR})
$(info LKR_FILE = ${LKR_FILE})
$(info COMPATIBLE_MODE = ${COMPATIBLE_MODE})
$(info ----------------------------)
$(info )



NET_EXT = _reloc
NET_EXT_MEM = _reloc_mempools

# options
RT_ATON_DEFINES = -DMODEL_CONF=\"${TARGET}_reloc_conf.h\"
RT_ATON_DEFINES += -DLL_ATON_DUMP_DEBUG_API
RT_ATON_DEFINES += -DLL_ATON_PLATFORM=LL_ATON_PLAT_STM32N6
RT_ATON_DEFINES += -DLL_ATON_OSAL=LL_ATON_OSAL_BARE_METAL -DLL_ATON_RT_MODE=LL_ATON_RT_ASYNC
RT_ATON_DEFINES += -DLL_ATON_SW_FALLBACK
ifeq ($(strip $(EB_DBG_INFO)),y)
RT_ATON_DEFINES += -DLL_ATON_EB_DBG_INFO
endif
RT_ATON_DEFINES += -DLL_ATON_DBG_BUFFER_INFO_EXCLUDED=1
RT_ATON_DEFINES += -DLL_ATON_RT_RELOC
ifeq ($(strip $(ECBLOB_IN_PARAMS)),y)
RT_ATON_DEFINES += -DECBLOB_CONST_SECTION="__attribute__((used, section (\".const_ec_blob\"), ))"
endif
# RT_ATON_DEFINES += -DNDEBUG

RT_RELOC_DEFINES += -DBUILD_AI_NETWORK_RELOC 
CFLAGS_OPT += -std=gnu99 -fno-builtin
CFLAGS_OPT += -fvisibility=protected
CFLAGS_OPT += -fno-unwind-tables
CFLAGS_OPT += -ffunction-sections
CFLAGS_OPT += -fdata-sections
CFLAGS_OPT += -fomit-frame-pointer
# ADDITIONAL FLAGS FOR v1.1 CLANG 
#  - short enums seems safer for deployment as it is the default ABI usage by a lot of other tested toolchains
CFLAGS_OPT += --sysroot ${LLVM_SYSROOT}

ifeq ($(strip $(COMPATIBLE_MODE)),y)
CFLAGS_OPT += -fshort-enums
# CFLAGS_OPT += -fno-short-wchar
endif

CFLAGS_OPT += -Os

# cortex-m55 options
#CORE_OPTIONS += -mcpu=cortex-m55 -mfpu=fpv4-sp-d16 -mfloat-abi=hard
CORE_OPTIONS += --target=$(TARGET_TRIPLET)

# secure mode
ifneq ($(strip $(SECURE_MODE)),)
# cmse is not compatible with ROPI/RWPI 
CORE_OPTIONS += -mcmse
endif

CFLAGS_PIC += -fropi -frwpi

LDFLAGS_OPT += -T ${LKR_FILE}
LDFLAGS_OPT += -nostdlib -fno-builtin -fropi -frwpi
LDFLAGS_OPT += -Wl,--gc-sections -Wl,--cref -Bstatic
LDFLAGS_OPT += -Wl,--emit-relocs
# LDFLAGS_OPT += -Wl,--unresolved-symbols=ignore-in-object-files
LDFLAGS_OPT += -Wl,-Map,${BUILD_DIR}/${TARGET}.map
#LDFLAGS_OPT += -Wl,--allow-multiple-definition

LDFLAGS_OPT += ${SW_LIB_PATH}


SRC += ${BUILD_DIR}/${TARGET}${NET_EXT}.c
SRC += ${BUILD_DIR}/${TARGET}${NET_EXT_MEM}.c
SRC += $(RT_ATON_DIR)/ll_aton.c
SRC += $(RT_ATON_DIR)/ll_aton_util.c
# SRC += $(RT_ATON_DIR)/ll_aton_lib.c
SRC += $(RT_ATON_DIR)/ll_aton_lib_sw_operators.c
SRC += $(RT_ATON_DIR)/ll_sw_integer.c
SRC += $(RT_ATON_DIR)/ll_sw_float.c
SRC += $(RT_ATON_DIR)/ecloader.c

OBJ += $(BUILD_DIR)/${TARGET}${NET_EXT}.o
OBJ += $(BUILD_DIR)/ll_aton.o
OBJ += $(BUILD_DIR)/ll_aton_util.o
OBJ += $(BUILD_DIR)/ll_sw_integer.o
OBJ += $(BUILD_DIR)/ll_sw_float.o
OBJ += $(BUILD_DIR)/ll_aton_lib_sw_operators.o
OBJ += $(BUILD_DIR)/ecloader.o

OBJ_EXTRA = $(BUILD_DIR)/${TARGET}${NET_EXT_MEM}.o $(BUILD_DIR)/ll_aton_reloc_callbacks.o

CFLAGS += ${CORE_OPTIONS} ${CFLAGS_PIC} ${CFLAGS_OPT} ${RT_RELOC_DEFINES} ${RT_ATON_DEFINES}
CFLAGS += -I${RT_ATON_DIR} -I${PLT_DIR} -I${PLT_DIR}/.. -I${BUILD_DIR}
LDFLAGS += ${LDFLAGS_OPT}


all: $(BUILD_DIR)/${TARGET}.elf

clean:
	$(RM) ${BUILD_DIR}/*.o
	$(RM) ${BUILD_DIR}/*.d
	$(RM) ${BUILD_DIR}/*.hex
	$(RM) ${BUILD_DIR}/$(TARGET).*

$(BUILD_DIR)/${TARGET}${NET_EXT}.o:  ${BUILD_DIR}/${TARGET}${NET_EXT}.c ${RT_ATON_DIR}/ll_aton_reloc_network.h
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/${TARGET}${NET_EXT}_mempools.o:  ${BUILD_DIR}/${TARGET}${NET_EXT}_mempools.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_aton_reloc_callbacks.o:  ${RT_ATON_DIR}/ll_aton_reloc_callbacks.c ${RT_ATON_DIR}/ll_aton_reloc_network.h
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_aton.o:  ${RT_ATON_DIR}/ll_aton.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_aton_lib.o:  ${RT_ATON_DIR}/ll_aton_lib.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_aton_util.o:  ${RT_ATON_DIR}/ll_aton_util.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_aton_lib_sw_operators.o: ${RT_ATON_DIR}/ll_aton_lib_sw_operators.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -DNDEBUG -I${RT_LIB_DIR}/inc -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_sw_integer.o: ${RT_ATON_DIR}/ll_sw_integer.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -I${SW_LIB_INC_DIR} -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ll_sw_float.o: ${RT_ATON_DIR}/ll_sw_float.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -I${SW_LIB_INC_DIR} -MMD -c "$<" -o "$@"

$(BUILD_DIR)/ecloader.o: ${RT_ATON_DIR}/ecloader.c
	mkdir -p $(@D)
	$(CC) $(CFLAGS) -DNDEBUG -I ${SW_LIB_INC_DIR} -MMD -c "$<" -o "$@"

$(BUILD_DIR)/${TARGET}.elf: ${OBJ} $(OBJ_EXTRA) ${LKR_FILE}
	mkdir -p $(@D)
	$(CC) ${CORE_OPTIONS} ${CFLAGS_PIC} ${CFLAGS_OPT}  ${OBJ} ${LDFLAGS} $(OBJ_EXTRA) -o "$@"
	$(OBJCOPY) -j.relocs -j.flash -j.data -O binary "$@" "$@.bin"
	$(OBJDUMP) "$@" -h -DS -r > "$@.S"
	$(SIZE) "$@"
